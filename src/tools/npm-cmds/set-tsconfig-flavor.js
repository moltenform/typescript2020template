
/* eslint-disable @typescript-eslint/no-var-requires */
const fs = require('fs');
const os = require('os');
const path = require('path');

function copyTsConfig(isProd) {
    const header = `/* NOTE:: this is a generated file, changes here will be overwritten */`
    let spec = isProd ? 'production' : 'development'
    
    let src = path.join(__dirname, `../../tsconfig.${spec}.json`)
    let dest = path.join(__dirname, `../../tsconfig.json`)
    let text = fs.readFileSync(src, {encoding: "utf8"})
    text = header + os.EOL + os.EOL + text;
    fs.writeFileSync(dest, text, {encoding: "utf8"})
}

function copyConstant(isProd) {
    const marker = `generated by set-tsconfig-flavor.js */`
    let code = fs.readFileSync('./src/util/util512Productname.ts', {encoding: "utf8"})
    const pts = code.split(marker)
    if (pts.length !== 2) {
        throw new Error('could not find marker in util512Productname.ts')
    }

    code = pts[0] + marker + os.EOL + os.EOL + 
        'export const isProductionBuild = () => ' + (isProd ? 'true' : 'false') + ';'
    fs.writeFileSync('./src/util/util512Productname.ts', code, {encoding: "utf8"})
}

function main(argv) {
    let isProd;
    if (argv.some(s => s === '--production')) {
        isProd = true;
    } else if (argv.some(s => s === '--development')) {
        isProd = false;
    } else {
        console.err('please specify either --production or --development')
        return process.exit(1)
    }
    
    copyTsConfig(isProd)
    copyConstant(isProd)
}

main(process.argv);
